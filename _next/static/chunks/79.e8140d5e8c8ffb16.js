(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[79,178],{75410:function(){},48628:function(){},31601:function(){},67792:function(){},34977:function(){},75042:function(){},76215:function(e,t,r){"use strict";r.r(t),r.d(t,{Camera:function(){return i}});var n=r(57437),o=r(2265),a=r(25848),l=r(72919);let i=e=>{let{onPoseDetected:t}=e,r=(0,o.useRef)(null),i=(0,o.useRef)(null),c=(0,o.useRef)(null),[s,u]=(0,o.useState)(null),[d,h]=(0,o.useState)(!1),[f,g]=(0,o.useState)(null);(0,o.useEffect)(()=>{try{"webgl"===l.getBackend()&&(console.log("WebGL backend detected, setting memory limits"),l.env().set("WEBGL_DELETE_TEXTURE_THRESHOLD",0),l.env().set("WEBGL_FORCE_F16_TEXTURES",!0))}catch(e){console.warn("Error setting TF memory limits")}},[]),(0,o.useEffect)(()=>{let e=!0;return(async()=>{try{try{await l.setBackend("webgpu"),console.log("Using WebGPU backend")}catch(e){console.log("WebGPU not available, falling back to WebGL"),await l.setBackend("webgl")}await l.ready();let t={modelType:a.cy.modelType.SINGLEPOSE_LIGHTNING,enableSmoothing:!0,trackerType:a.$b.Keypoint,multiPoseMaxDimension:128,enableTracking:!0,scoreThreshold:.3,minPoseScore:.25};if(!e)return;let r=await a.cH(a.oV.MoveNet,t);if(!e){r.dispose();return}u(r)}catch(t){console.error("TensorFlow/MoveNetの初期化に失敗しました:",t),e&&g("モデルの初期化に失敗: ".concat(t instanceof Error?t.message:"不明なエラー"))}})(),()=>{if(e=!1,s)try{s.dispose()}catch(e){console.warn("Error disposing detector:",e)}try{l.disposeVariables(),l.engine()&&"function"==typeof l.engine().endScope&&l.engine().endScope()}catch(e){console.warn("Error cleaning up TensorFlow resources:",e)}}},[]),(0,o.useEffect)(()=>{let e;if(!r.current||!i.current)return;let t=!1,n=()=>{if(!r.current||!i.current||!t){e=requestAnimationFrame(n);return}let o=r.current,a=i.current,l=a.getContext("2d");if(!l||o.readyState<2){e=requestAnimationFrame(n);return}(a.width!==o.videoWidth||a.height!==o.videoHeight)&&(a.width=o.videoWidth,a.height=o.videoHeight,c.current&&(c.current.width=o.videoWidth,c.current.height=o.videoHeight)),l.drawImage(o,0,0,a.width,a.height),e=requestAnimationFrame(n)},o=()=>{e&&cancelAnimationFrame(e),e=requestAnimationFrame(n)};return(async()=>{try{console.log("カメラの初期化を開始します..."),console.log("カメラへのアクセスを要求しています...");let e=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:320,max:480},height:{ideal:240,max:360},facingMode:"user",frameRate:{ideal:12,max:15}},audio:!1});if(console.log("カメラアクセス成功:",e),r.current){r.current.srcObject=e,r.current.muted=!0,r.current.playsInline=!0,await new Promise(e=>{r.current?r.current.onloadeddata=()=>{console.log("ビデオデータ読み込み完了"),e()}:e()});try{await r.current.play(),console.log("ビデオの再生を開始しました"),t=!0,h(!0),g(null),o()}catch(t){console.error("ビデオの再生に失敗しました:",t);let e=t instanceof Error?t.message:"Unknown error";g("ビデオの再生に失敗しました: ".concat(e))}}}catch(e){console.error("カメラへのアクセスに失敗しました:",e),e instanceof DOMException?"NotAllowedError"===e.name?g("カメラへのアクセスが拒否されました。ブラウザの設定でカメラへのアクセスを許可してください。"):"NotFoundError"===e.name?g("カメラが見つかりません。カメラが接続されているか確認してください。"):"NotReadableError"===e.name?g("カメラにアクセスできません。別のアプリがカメラを使用している可能性があります。"):g("カメラエラー: ".concat(e.message||"不明なエラーが発生しました")):g("不明なエラーが発生しました")}})(),()=>{t=!1,e&&cancelAnimationFrame(e),r.current&&r.current.srcObject&&(r.current.srcObject.getTracks().forEach(e=>e.stop()),r.current.srcObject=null)}},[]),(0,o.useEffect)(()=>{if(!c.current||!d||!s)return;let e=null,n=!1,o=async()=>{if(!n&&r.current&&c.current&&s){n=!0;try{let e=r.current,o=c.current;if(e.readyState<2){n=!1;return}let a=o.getContext("2d");if(!a){n=!1;return}a.clearRect(0,0,o.width,o.height),await l.nextFrame();try{let r=await s.estimatePoses(e,{flipHorizontal:!1,maxPoses:1});try{l.engine()&&"function"==typeof l.engine().endScope&&l.engine().endScope()}catch(e){console.warn("Error in TF endScope:",e)}if(r.length>0){let e=r[0];t(e),m(a,e)}}catch(e){console.error("Pose estimation failed:",e)}}catch(e){console.error("Detection loop error:",e)}finally{n=!1}}};return e=setInterval(o,150),o(),()=>{var t;e&&clearInterval(e);let r=null===(t=c.current)||void 0===t?void 0:t.getContext("2d");r&&c.current&&r.clearRect(0,0,c.current.width,c.current.height)}},[s,d,t]);let m=(e,t)=>{e.clearRect(0,0,e.canvas.width,e.canvas.height);let r=t.keypoints;r.forEach(t=>{if(t.score&&t.score>.3){let{x:r,y:n}=t;e.beginPath(),e.arc(r,n,4,0,2*Math.PI),e.fillStyle="rgba(255, 0, 0, 0.8)",e.fill()}});let n=new Map(r.map((e,t)=>[e.name,t]));[["left_shoulder","right_shoulder"],["left_hip","right_hip"],["left_shoulder","left_hip"],["right_shoulder","right_hip"],["left_shoulder","left_elbow"],["left_elbow","left_wrist"],["right_shoulder","right_elbow"],["right_elbow","right_wrist"]].forEach(t=>{let[o,a]=t,l=n.get(o),i=n.get(a);if(void 0!==l&&void 0!==i&&r[l].score&&r[i].score&&r[l].score>.3&&r[i].score>.3){let t=r[l],n=r[i];e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.lineWidth=2,e.strokeStyle="rgba(0, 255, 0, 0.6)",e.stroke()}})};return(0,n.jsx)("div",{className:"relative w-full max-w-[640px] mx-auto",children:f?(0,n.jsxs)("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4",children:[(0,n.jsx)("p",{className:"font-bold",children:"エラー"}),(0,n.jsx)("p",{children:f}),(0,n.jsx)("button",{className:"mt-2 bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-4 rounded",onClick:()=>location.reload(),children:"再試行"})]}):(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)("video",{ref:r,className:"hidden",playsInline:!0,muted:!0,autoPlay:!0}),(0,n.jsx)("canvas",{ref:i,className:"w-full h-auto rounded-lg border border-gray-300 shadow-lg"}),(0,n.jsx)("canvas",{ref:c,className:"absolute top-0 left-0 w-full h-full pointer-events-none",style:{zIndex:10}})]})})};t.default=i}}]);